#include "Termgl.h"

namespace termgl {

    // ============================================================================
    // INTERNAL FONT DATA (8x16)
    // ============================================================================
    static const unsigned char FONT8x16[128][16] = {
        {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0},
        {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0},
        // 32: SPACE
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 33: !
        {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
        // 34: "
        {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 35: #
        {0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00},
        // 36: $
        {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
        // 37: %
        {0x00,0x00,0x00,0xC6,0xCC,0x18,0x30,0x60,0xC0,0x66,0xC6,0x00,0x00,0x00,0x00,0x00},
        // 38: &
        {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00},
        // 39: '
        {0x00,0x18,0x18,0x18,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 40: (
        {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
        // 41: )
        {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
        // 42: *
        {0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x3C,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
        // 43: +
        {0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x7E,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
        // 44: ,
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x08,0x00,0x00,0x00},
        // 45: -
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 46: .
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
        // 47: /
        {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
        // 48: 0
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 49: 1
        {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
        // 50: 2
        {0x00,0x00,0x3C,0x66,0xC3,0x03,0x06,0x0C,0x18,0x30,0x60,0xFF,0x00,0x00,0x00,0x00},
        // 51: 3
        {0x00,0x00,0x3C,0x66,0xC3,0x03,0x1E,0x03,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 52: 4
        {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
        // 53: 5
        {0x00,0x00,0xFF,0xC0,0xC0,0xFC,0x06,0x03,0x03,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 54: 6
        {0x00,0x00,0x3C,0x66,0xC0,0xC0,0xFC,0xC6,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 55: 7
        {0x00,0x00,0xFF,0xC3,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
        // 56: 8
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0x7E,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 57: 9
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0x7E,0x03,0x03,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 58: :
        {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
        // 59: ;
        {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x08,0x00,0x00,0x00,0x00},
        // 60: <
        {0x00,0x00,0x06,0x18,0x60,0xC0,0xC0,0x60,0x18,0x06,0x00,0x00,0x00,0x00,0x00,0x00},
        // 61: =
        {0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 62: >
        {0x00,0x00,0x60,0x18,0x06,0x03,0x03,0x06,0x18,0x60,0x00,0x00,0x00,0x00,0x00,0x00},
        // 63: ?
        {0x00,0x00,0x3C,0x66,0xC3,0x06,0x0C,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
        // 64: @
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xDB,0xDB,0xDF,0xD8,0xC0,0xC0,0x7E,0x00,0x00,0x00},
        // 65: A
        {0x00,0x00,0x18,0x3C,0x66,0x66,0xC3,0xC3,0xFF,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
        // 66: B
        {0x00,0x00,0xF8,0x6C,0x66,0x66,0x7C,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
        // 67: C
        {0x00,0x00,0x3C,0x66,0xC3,0xC0,0xC0,0xC0,0xC0,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 68: D
        {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
        // 69: E
        {0x00,0x00,0xFE,0x62,0x60,0x64,0x7C,0x64,0x60,0x62,0xFE,0x00,0x00,0x00,0x00,0x00},
        // 70: F
        {0x00,0x00,0xFE,0x62,0x60,0x64,0x7C,0x64,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00},
        // 71: G
        {0x00,0x00,0x3C,0x66,0xC3,0xC0,0xC0,0xCF,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 72: H
        {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xFF,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
        // 73: I
        {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
        // 74: J
        {0x00,0x00,0x0F,0x06,0x06,0x06,0x06,0x06,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
        // 75: K
        {0x00,0x00,0xC6,0xCC,0xD8,0xF0,0xF8,0xD8,0xCC,0xC6,0xC3,0x00,0x00,0x00,0x00},
        // 76: L
        {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0xFE,0x00,0x00,0x00,0x00,0x00},
        // 77: M
        {0x00,0x00,0xC3,0xC3,0xE7,0xFF,0xDB,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
        // 78: N
        {0x00,0x00,0xC3,0xC3,0xE3,0xF3,0xDB,0xCF,0xC7,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
        // 79: O
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 80: P
        {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00},
        // 81: Q
        {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xDB,0xCF,0x66,0x3C,0x0F,0x00,0x00,0x00},
        // 82: R
        {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE3,0x00,0x00,0x00,0x00},
        // 83: S
        {0x00,0x00,0x3C,0x66,0xC3,0x60,0x3C,0x06,0x03,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 84: T
        {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
        // 85: U
        {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 86: V
        {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x00,0x00,0x00,0x00},
        // 87: W
        {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xDB,0xFF,0xE7,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
        // 88: X
        {0x00,0x00,0xC3,0x66,0x3C,0x18,0x18,0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00,0x00},
        // 89: Y
        {0x00,0x00,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00},
        // 90: Z
        {0x00,0x00,0xFF,0xC3,0x86,0x0C,0x18,0x30,0x60,0xC1,0xC3,0xFF,0x00,0x00,0x00,0x00},
        // 91: [
        {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
        // 92: \ (Backslash)
        {0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x00,0x00,0x00},
        // 93: ]
        {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
        // 94: ^
        {0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 95: _
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},
        // 96: `
        {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 97: a
        {0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0x06,0x3E,0x66,0x66,0x3F,0x00,0x00,0x00,0x00},
        // 98: b
        {0x00,0x00,0xC0,0xC0,0xC0,0xDC,0xE6,0xC6,0xC6,0xC6,0xE6,0xDC,0x00,0x00,0x00,0x00},
        // 99: c
        {0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 100: d
        {0x00,0x00,0x06,0x06,0x06,0x3E,0x66,0xC6,0xC6,0xC6,0x66,0x3E,0x00,0x00,0x00,0x00},
        // 101: e
        {0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0xC6,0xFE,0xC0,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 102: f
        {0x00,0x00,0x1C,0x36,0x30,0x30,0x78,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
        // 103: g
        {0x00,0x00,0x00,0x00,0x00,0x3E,0x66,0xC6,0xC6,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00},
        // 104: h
        {0x00,0x00,0xC0,0xC0,0xC0,0xDC,0xE6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
        // 105: i
        {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
        // 106: j
        {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x3C,0x00,0x00},
        // 107: k
        {0x00,0x00,0xC0,0xC0,0xC0,0xCC,0xD8,0xF0,0xF8,0xD8,0xCC,0xC6,0x00,0x00,0x00,0x00},
        // 108: l
        {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
        // 109: m
        {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xD6,0x00,0x00,0x00,0x00},
        // 110: n
        {0x00,0x00,0x00,0x00,0x00,0xDC,0xE6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
        // 111: o
        {0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 112: p
        {0x00,0x00,0x00,0x00,0x00,0xDC,0xE6,0xC6,0xC6,0xC6,0xE6,0xDC,0xC0,0xC0,0x00,0x00},
        // 113: q
        {0x00,0x00,0x00,0x00,0x00,0x3E,0x66,0xC6,0xC6,0xC6,0x66,0x3E,0x06,0x06,0x00,0x00},
        // 114: r
        {0x00,0x00,0x00,0x00,0x00,0xDE,0xE6,0xC0,0xC0,0xC0,0xC0,0xE0,0x00,0x00,0x00,0x00},
        // 115: s
        {0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 116: t
        {0x00,0x00,0x10,0x10,0x10,0x7C,0x30,0x30,0x30,0x30,0x34,0x18,0x00,0x00,0x00,0x00},
        // 117: u
        {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3E,0x00,0x00,0x00,0x00},
        // 118: v
        {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
        // 119: w
        {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xDB,0xFF,0xE7,0xC3,0x00,0x00,0x00,0x00},
        // 120: x
        {0x00,0x00,0x00,0x00,0x00,0xC3,0x66,0x3C,0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00},
        // 121: y
        {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x70,0x00,0x00,0x00},
        // 122: z
        {0x00,0x00,0x00,0x00,0x00,0xFF,0xC3,0x06,0x1C,0x30,0x60,0xFF,0x00,0x00,0x00,0x00},
        // 123: {
        {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
        // 124: |
        {0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
        // 125: }
        {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
        // 126: ~
        {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        // 127: (DEL)
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    };

    // ============================================================================
    // UI IMPLEMENTATION
    // ============================================================================

    void Window::drawText(int x, int y, const std::string& text, Color color) {
        // Optimized drawText: Only check clipping once
        transformCoordinates(x, y);

        int ox = x;
        
        int clipMinX = 0, clipMaxX = width;
        int clipMinY = 0, clipMaxY = height;

        if (activePartitionID != -1) {
            const auto& p = partitions[activePartitionID];
            clipMinX = p.rect.x + 1; 
            clipMaxX = p.rect.x + p.rect.w - 1;
            clipMinY = p.rect.y + 21; 
            clipMaxY = p.rect.y + p.rect.h - 1;
        }

        uint32_t c = color.toInt();

        for (char ch : text) {
            if (ch == '\n') { y += 20; x = ox; continue; }
            
            // Fast culling of characters outside view
            if (x >= clipMaxX) break; // End of line visible
            if (y >= clipMaxY) break; // Bottom visible
            if (x + 8 < clipMinX || y + 16 < clipMinY) {
                x += 9;
                continue;
            }

            unsigned char glyphIndex = (unsigned char)ch;
            if (glyphIndex < 32 || glyphIndex > 127) glyphIndex = 63;
            
            // Draw character pixels
            for (int row = 0; row < 16; row++) {
                int drawY = y + row;
                if (drawY < clipMinY || drawY >= clipMaxY) continue;

                unsigned char line = FONT8x16[glyphIndex][row];
                uint32_t* bufRow = &buffer[drawY * width];
                
                for (int col = 0; col < 8; col++) {
                    int drawX = x + col;
                    if (drawX >= clipMinX && drawX < clipMaxX) {
                        if ((line >> (7 - col)) & 1) bufRow[drawX] = c;
                    }
                }
            }
            x += 9;
        }
    }

    bool Window::drawButton(int x, int y, int w, int h, const std::string& text) {
        bool hovering = isMouseHovering(x, y, w, h);
        bool clicked = isButtonClicked(x, y, w, h);

        Color c1 = hovering ? Color(40, 40, 40) : Color(20, 20, 20);
        Color c2 = hovering ? Color(30, 30, 30) : Color(10, 10, 10);

        if (clicked) {
            c1 = Color(60, 60, 60);
            c2 = Color(40, 40, 40);
        }

        fillGradientRect(x, y, w, h, c1, c2, true);
        drawRect(x, y, w, h, Color(80, 80, 80));

        int textW = text.length() * 9;
        drawText(x + (w - textW) / 2, y + (h - 16) / 2, text, Color::White());

        return clicked;
    }

    int Window::drawList(int x, int y, int w, int h, const std::vector<std::string>& items, int& scrollOffset, int itemHeight) {
        int totalHeight = items.size() * itemHeight;

        if (isMouseHovering(x, y, w, h)) {
            scrollOffset -= mouseScrollDelta;
        }

        int maxScroll = std::max(0, totalHeight - h);
        if (scrollOffset < 0) scrollOffset = 0;
        if (scrollOffset > maxScroll) scrollOffset = maxScroll;

        fillRect(x, y, w, h, Color(0, 0, 0));
        drawRect(x, y, w, h, Color(60, 60, 60));

        int startIndex = scrollOffset / itemHeight;
        int endIndex = (scrollOffset + h) / itemHeight + 1;
        if (startIndex < 0) startIndex = 0;
        if (endIndex > (int)items.size()) endIndex = items.size();

        int clickedIndex = -1;

        for (int i = startIndex; i < endIndex; ++i) {
            int itemY = y + (i * itemHeight) - scrollOffset;

            // Only draw visual items within the box
            if (itemY + itemHeight <= y || itemY >= y + h) continue;

            bool hovered = isMouseHovering(x, itemY, w - 15, itemHeight);
            if (hovered && itemY >= y && itemY + itemHeight <= y + h) {
                fillRect(x + 1, itemY, w - 17, itemHeight, Color(30, 30, 30));
                if (isButtonClicked(x, itemY, w - 15, itemHeight)) clickedIndex = i;
            }

            // Clip text manually if needed or rely on loop bounds
            if (itemY + 16 > y && itemY < y + h) {
                int drawY = itemY + (itemHeight - 16) / 2;
                drawText(x + 5, drawY, items[i], Color::White());
            }
        }

        int barTrackH = h - 2;
        int barH = (totalHeight > 0) ? (h * barTrackH / std::max(h, totalHeight)) : barTrackH;
        if (barH < 10) barH = 10;

        float scrollRatio = (float)scrollOffset / maxScroll;
        if (maxScroll == 0) scrollRatio = 0;
        int barY = y + 1 + (int)(scrollRatio * (barTrackH - barH));

        fillRect(x + w - 12, y, 12, h, Color(15, 15, 15)); 
        fillRect(x + w - 10, barY, 8, barH, Color(60, 60, 60));

        return clickedIndex;
    }

    bool Window::isMouseHovering(int x, int y, int w, int h) const {
        Vec2 m = getMousePos();
        return (m.x >= x && m.x < x + w && m.y >= y && m.y < y + h);
    }

    bool Window::isButtonClicked(int x, int y, int w, int h) const {
        return isMouseHovering(x, y, w, h) && mouseLeftPressed;
    }

}
